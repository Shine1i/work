# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Tech Stack

TanStack Start (React 19) full-stack framework with:
- **Router**: TanStack Router (file-based routing)
- **Query**: TanStack Query for data fetching/caching
- **UI**: Tailwind CSS v4 + shadcn/ui components
- **Auth**: Better Auth (email/password + OAuth2)
- **Database**: PostgreSQL via Drizzle ORM
- **Compiler**: React Compiler enabled (Babel plugin)

## Essential Commands

### Development
```bash
pnpm dev              # Start dev server on :3000
pnpm build            # Production build
pnpm start            # Run production server
```

### Code Quality
```bash
pnpm check-types      # TypeScript type checking
pnpm lint             # ESLint
pnpm format           # Prettier formatting
pnpm check            # Run all three above
```

### Database
```bash
pnpm db push          # Push schema changes to DB (dev)
pnpm db generate      # Generate migration files
pnpm db migrate       # Run migrations
pnpm db studio        # Open Drizzle Studio GUI
```

### Auth
```bash
pnpm auth:secret      # Generate BETTER_AUTH_SECRET
pnpm auth:generate    # Regenerate auth schema from config
```

### UI Components
```bash
pnpm ui add <component>  # Add shadcn/ui component
```

## Architecture

### Routing Structure
- **File-based routing** in `src/routes/`
- Route groups: `(authenticated)` for protected routes, `(auth-pages)` for login/signup
- `__root.tsx` is the root layout with devtools, theme provider, toaster
- `routeTree.gen.ts` is auto-generated - don't edit manually

### Authentication Flow
1. Better Auth configured in `src/lib/auth/auth.ts`
2. Auth queries defined in `src/lib/auth/queries.ts` using TanStack Query
3. Root route (`__root.tsx`) prefetches user data
4. Protected routes use `(authenticated)/route.tsx` which:
   - Ensures query data is fresh with `revalidateIfStale: true`
   - Redirects to `/login` if unauthenticated
   - Returns non-null user to child routes

### Middleware Pattern
- `src/lib/auth/middleware.ts` provides `authMiddleware` for server functions
- Use in server functions to force authentication and get user context
- Sets 401 status and throws on unauthorized access

### Database Layer
- **Connection**: `src/lib/db/index.ts` exports singleton `db` instance
- **Schemas**: `src/lib/db/schema/` with separate files per domain
  - `auth.schema.ts` generated by Better Auth CLI
  - `jobs.schema.ts` for custom tables
  - `index.ts` re-exports all schemas
- **Config**: `drizzle.config.ts` uses snake_case convention
- **Migrations**: Generated in `drizzle/` directory

### Server vs Client Code
- Use `serverOnly()` wrapper for server-exclusive code (auth, db)
- Server functions can use middleware via `.middleware([authMiddleware])`
- Environment validation via `@t3-oss/env-core` in `src/env/server.ts`

### Query Integration
- Router and Query integrated via `setupRouterSsrQueryIntegration` in `router.tsx`
- `defaultPreloadStaleTime: 0` - router doesn't cache, delegates to react-query
- Router context includes `queryClient` and `user` (null on root, non-null in authenticated routes)

### Path Aliases
- `~/*` maps to `src/*` (configured in tsconfig.json and vite.config.ts)
- Always use `~/` prefix for absolute imports from src

## Configuration Notes

### Environment Setup
1. Copy `.env.example` to `.env`
2. Set `DATABASE_URL` (or use `docker-compose up -d` for local Postgres)
3. Generate `BETTER_AUTH_SECRET` via `pnpm auth:secret`
4. OAuth providers optional - set callback URLs to `http://localhost:3000/api/auth/callback/<provider>`

### TypeScript
- Strict mode enabled
- Path aliases: `~/*` â†’ `src/*`
- Type checking does NOT emit files (use Vite for builds)

### ESLint
- Flat config format
- Plugins: TanStack Query/Router, React Hooks, React, TypeScript
- Prettier integration via `eslint-config-prettier`

### Vite
- React Compiler enabled (target: React 19)
- Tailwind v4 via `@tailwindcss/vite`
- TSConfig paths resolved via `vite-tsconfig-paths`

## Development Patterns

### Adding Auth Schema Changes
1. Modify Better Auth config in `src/lib/auth/auth.ts`
2. Run `pnpm auth:generate` to update `auth.schema.ts`
3. Run `pnpm db push` (dev) or `pnpm db generate && pnpm db migrate` (prod)

### Creating Protected Routes
- Place files under `src/routes/(authenticated)/`
- Access `user` from route context (typed as non-null)
- Example: `route.tsx` has access to `context.user` with full type safety

### Server Functions
- Define in route files or separate modules
- Use `createServerFn()` from `@tanstack/react-start`
- Chain middleware with `.middleware([authMiddleware])` for auth

### Component Organization
- `src/components/ui/` - shadcn/ui components
- `src/components/hero/` - landing page components
- `src/components/magicui/` - animation/UI utilities
- Theme components: `theme-provider.tsx`, `theme-toggle.tsx`

## Important Files

- `src/router.tsx` - Router creation and Query integration
- `src/routeTree.gen.ts` - Auto-generated route tree (don't edit)
- `src/lib/auth/auth.ts` - Better Auth configuration
- `src/lib/db/index.ts` - Database connection
- `drizzle.config.ts` - Drizzle Kit configuration
- `vite.config.ts` - Vite + TanStack Start + React Compiler config
