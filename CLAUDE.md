# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Tech Stack

TanStack Start (React 19) full-stack framework with:
- **Router**: TanStack Router (file-based routing)
- **Query**: TanStack Query for data fetching/caching
- **UI**: Tailwind CSS v4 + shadcn/ui components
- **Auth**: Better Auth (email/password + OAuth2)
- **Database**: PostgreSQL via Drizzle ORM
- **Compiler**: React Compiler enabled (Babel plugin)

## Essential Commands

### Development
```bash
pnpm dev              # Start dev server on :3000
pnpm build            # Production build
pnpm start            # Run production server
```

### Code Quality
```bash
pnpm check-types      # TypeScript type checking
pnpm lint             # ESLint
pnpm format           # Prettier formatting
pnpm check            # Run all three above
```

### Database
```bash
pnpm db push          # Push schema changes to DB (dev)
pnpm db generate      # Generate migration files
pnpm db migrate       # Run migrations
pnpm db studio        # Open Drizzle Studio GUI
```

### Auth
```bash
pnpm auth:secret      # Generate BETTER_AUTH_SECRET
pnpm auth:generate    # Regenerate auth schema from config
```

### UI Components
```bash
pnpm ui add <component>  # Add shadcn/ui component
```

## Architecture

### Routing Structure
- **File-based routing** in `src/routes/`
- Route groups: `(authenticated)` for protected routes, `(auth-pages)` for login/signup
- `__root.tsx` is the root layout with devtools, theme provider, toaster
- `routeTree.gen.ts` is auto-generated - don't edit manually

### Authentication Flow
1. Better Auth configured in `src/lib/auth/auth.ts`
2. Auth queries defined in `src/lib/auth/queries.ts` using TanStack Query
3. Root route (`__root.tsx`) prefetches user data
4. Protected routes use `(authenticated)/route.tsx` which:
   - Ensures query data is fresh with `revalidateIfStale: true`
   - Redirects to `/login` if unauthenticated
   - Returns non-null user to child routes

### Middleware Pattern
- `src/lib/auth/middleware.ts` provides `authMiddleware` for server functions
- Use in server functions to force authentication and get user context
- Sets 401 status and throws on unauthorized access

### Database Layer
- **Connection**: `src/lib/db/index.ts` exports singleton `db` instance
- **Schemas**: `src/lib/db/schema/` with separate files per domain
  - `auth.schema.ts` generated by Better Auth CLI
  - `jobs.schema.ts` for custom tables
  - `index.ts` re-exports all schemas
- **Config**: `drizzle.config.ts` uses snake_case convention
- **Migrations**: Generated in `drizzle/` directory

### Server vs Client Code
- Use `serverOnly()` wrapper for server-exclusive code (auth, db)
- Server functions can use middleware via `.middleware([authMiddleware])`
- Environment validation via `@t3-oss/env-core` in `src/config/env/server.ts`

### Query Integration
- Router and Query integrated via `setupRouterSsrQueryIntegration` in `router.tsx`
- `defaultPreloadStaleTime: 0` - router doesn't cache, delegates to react-query
- Router context includes `queryClient` and `user` (null on root, non-null in authenticated routes)

### Path Aliases
- `~/*` maps to `src/*` (configured in tsconfig.json and vite.config.ts)
- Always use `~/` prefix for absolute imports from src

## Configuration Notes

### Environment Setup
1. Copy `.env.example` to `.env`
2. Set `DATABASE_URL` (or use `docker-compose up -d` for local Postgres)
3. Generate `BETTER_AUTH_SECRET` via `pnpm auth:secret`
4. OAuth providers optional - set callback URLs to `http://localhost:3000/api/auth/callback/<provider>`

### TypeScript
- Strict mode enabled
- Path aliases: `~/*` → `src/*`
- Type checking does NOT emit files (use Vite for builds)

### ESLint
- Flat config format
- Plugins: TanStack Query/Router, React Hooks, React, TypeScript
- Prettier integration via `eslint-config-prettier`

### Vite
- React Compiler enabled (target: React 19)
- Tailwind v4 via `@tailwindcss/vite`
- TSConfig paths resolved via `vite-tsconfig-paths`

## Development Patterns

### Adding Auth Schema Changes
1. Modify Better Auth config in `src/lib/auth/auth.ts`
2. Run `pnpm auth:generate` to update `auth.schema.ts`
3. Run `pnpm db push` (dev) or `pnpm db generate && pnpm db migrate` (prod)

### Creating Protected Routes
- Place files under `src/routes/(authenticated)/`
- Access `user` from route context (typed as non-null)
- Example: `route.tsx` has access to `context.user` with full type safety

### Server Functions
- Define in route files or separate modules
- Use `createServerFn()` from `@tanstack/react-start`
- Chain middleware with `.middleware([authMiddleware])` for auth

### Project Structure

This project follows a feature-based architecture with clear separation of concerns:

```
src/
├── routes/              # TanStack Router file-based routing
│   ├── __root.tsx      # Root layout (replaces app.tsx/provider.tsx in other frameworks)
│   ├── (authenticated)/ # Protected route group
│   └── (auth-pages)/   # Auth-related pages (login, signup)
├── features/           # Feature-based modules (see below)
│   ├── auth/
│   │   ├── api/       # Server functions and queries
│   │   └── components/ # Auth forms and status components
│   ├── landing/       # Complete landing page feature (self-contained)
│   │   ├── api/
│   │   │   ├── cities/     # Popular cities queries + server functions
│   │   │   ├── companies/  # Popular companies queries + server functions
│   │   │   └── jobs/       # Recent jobs queries + server functions
│   │   ├── components/ # All landing UI (hero, sections, job cards)
│   │   └── config/    # Feature configs (stats, cities, features)
│   └── navigation/
│       ├── components/ # Navigation components
│       └── config/    # Navigation configuration
├── components/         # ONLY shared components
│   ├── ui/            # shadcn/ui component library
│   ├── magicui/       # Animation and visual effects
│   └── app/           # App-level infrastructure (theme, error boundaries, footer)
├── lib/               # ONLY shared infrastructure
│   ├── auth/          # Core auth config (auth.ts, middleware.ts, auth-client.ts)
│   └── db/            # Database connection and schemas
├── config/
│   ├── env/           # Environment variable validation
│   └── categories.tsx # Global configurations
├── assets/            # Static files (images, fonts)
├── hooks/             # Shared React hooks
├── stores/            # Global state management
├── testing/           # Test utilities and mocks
├── types/             # Shared TypeScript types
├── utils/             # Shared utility functions (cn helper)
└── router.tsx         # Router creation and Query integration
```

#### Feature Organization

Features are self-contained modules following a consistent structure:

**Feature Structure:**
```
features/[feature-name]/
├── api/              # Server functions (server-functions.ts) and queries (queries.ts)
├── components/       # Feature-specific components
├── config/          # Feature-specific configuration files
├── hooks/           # Feature-specific hooks (if needed)
├── types/           # Feature-specific types (if needed)
└── utils/           # Feature-specific utilities (if needed)
```

**Current Features:**
- **`features/auth/`** - Authentication with API (queries, server functions) and components (LoginForm, SignupForm, UserStatus, SignOutButton)
- **`features/landing/`** - Complete landing page feature (self-contained, no cross-feature imports)
  - **`api/`** - Organized by domain: `cities/`, `companies/`, `jobs/` (each with queries.ts + server-functions.ts)
  - **`components/`** - All landing components: hero (HeroSection, SearchForm, etc.), sections (Bento, Blog, FAQ, CTA, Popular), job cards (JobCard, ScoreIndicator)
  - **`config/`** - Feature configs (stats, cities, features)
- **`features/navigation/`** - Navigation components (CardNav) with navigation config

**Key Principles:**
- Feature-specific code (API, components, configs) lives within the feature
- Shared infrastructure (db, core auth) stays in `lib/`
- Shared UI components (shadcn, magicui) stay in `components/`
- API layer: `server-functions.ts` (TanStack Start server functions) + `queries.ts` (TanStack Query options)

#### TanStack Start Differences

Unlike other React frameworks, TanStack Start uses:
- **`__root.tsx`** instead of `app.tsx` - serves as root layout with providers
- **No separate `provider.tsx`** - providers are composed directly in `__root.tsx`
- **`router.tsx`** - router creation with Query integration happens here
- **File-based routing** in `routes/` with auto-generated `routeTree.gen.ts`

## Important Files

- `src/router.tsx` - Router creation and Query integration
- `src/routeTree.gen.ts` - Auto-generated route tree (don't edit)
- `src/lib/auth/auth.ts` - Better Auth configuration
- `src/lib/db/index.ts` - Database connection
- `drizzle.config.ts` - Drizzle Kit configuration
- `vite.config.ts` - Vite + TanStack Start + React Compiler config
